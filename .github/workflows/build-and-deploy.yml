name: Build and Deploy YARA Agent Services

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'agents/**'
      - 'infra/**'
      - 'docker-compose.yml'
      - '.github/workflows/build-and-deploy.yml'

env:
  REGISTRY_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
  DEV_TAG: dev-latest
  ORCHESTRATOR_IMAGE: yaragent-orchestrator
  MCP_SERVER_IMAGE: yaragent-mcp-server
  UI_IMAGE: yaragent-ui
  AGENT_POC_IMAGE: yaragent-agent-poc

jobs:
  build-and-push-orchestrator:
    name: Build and Push Orchestrator Service
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if orchestrator changed
        id: orchestrator-check
        run: |
          LAST_COMMIT=$(git log -1 --format=format:%H)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LAST_COMMIT)
          
          if echo "$CHANGED_FILES" | grep -q "services/business/orchestrator"; then
            echo "orchestrator_changed=true" >> $GITHUB_ENV
          else
            echo "orchestrator_changed=false" >> $GITHUB_ENV
          fi

      - name: Login to Docker Hub
        if: env.orchestrator_changed == 'true'
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login -u "${{ env.REGISTRY_USERNAME }}" --password-stdin

      - name: Build Orchestrator Image
        if: env.orchestrator_changed == 'true'
        run: |
          docker build --no-cache \
            -t "${{ env.REGISTRY_USERNAME }}/${{ env.ORCHESTRATOR_IMAGE }}:${{ env.DEV_TAG }}" \
            -f services/business/orchestrator/Dockerfile .

      - name: Push Orchestrator Image
        if: env.orchestrator_changed == 'true'
        run: |
          docker push "${{ env.REGISTRY_USERNAME }}/${{ env.ORCHESTRATOR_IMAGE }}:${{ env.DEV_TAG }}"

  build-and-push-mcp-server:
    name: Build and Push MCP Server Service
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if mcp-server changed
        id: mcp-check
        run: |
          LAST_COMMIT=$(git log -1 --format=format:%H)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LAST_COMMIT)
          
          if echo "$CHANGED_FILES" | grep -q "services/platform/mcp-server"; then
            echo "mcp_changed=true" >> $GITHUB_ENV
          else
            echo "mcp_changed=false" >> $GITHUB_ENV
          fi

      - name: Login to Docker Hub
        if: env.mcp_changed == 'true'
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login -u "${{ env.REGISTRY_USERNAME }}" --password-stdin

      - name: Build MCP Server Image
        if: env.mcp_changed == 'true'
        run: |
          docker build --no-cache \
            -t "${{ env.REGISTRY_USERNAME }}/${{ env.MCP_SERVER_IMAGE }}:${{ env.DEV_TAG }}" \
            -f services/platform/mcp-server/Dockerfile .

      - name: Push MCP Server Image
        if: env.mcp_changed == 'true'
        run: |
          docker push "${{ env.REGISTRY_USERNAME }}/${{ env.MCP_SERVER_IMAGE }}:${{ env.DEV_TAG }}"

  build-and-push-ui:
    name: Build and Push UI Service
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if UI changed
        id: ui-check
        run: |
          LAST_COMMIT=$(git log -1 --format=format:%H)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LAST_COMMIT)
          
          if echo "$CHANGED_FILES" | grep -q "services/business/ui"; then
            echo "ui_changed=true" >> $GITHUB_ENV
          else
            echo "ui_changed=false" >> $GITHUB_ENV
          fi

      - name: Login to Docker Hub
        if: env.ui_changed == 'true'
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login -u "${{ env.REGISTRY_USERNAME }}" --password-stdin

      - name: Build UI Image
        if: env.ui_changed == 'true'
        run: |
          docker build --no-cache \
            -t "${{ env.REGISTRY_USERNAME }}/${{ env.UI_IMAGE }}:${{ env.DEV_TAG }}" \
            -f services/business/ui/Dockerfile .

      - name: Push UI Image
        if: env.ui_changed == 'true'
        run: |
          docker push "${{ env.REGISTRY_USERNAME }}/${{ env.UI_IMAGE }}:${{ env.DEV_TAG }}"

  build-and-push-agent-poc:
    name: Build and Push Agent PoC
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if agent changed
        id: agent-check
        run: |
          LAST_COMMIT=$(git log -1 --format=format:%H)
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $LAST_COMMIT)
          
          if echo "$CHANGED_FILES" | grep -q "agents/windows-go/poc"; then
            echo "agent_changed=true" >> $GITHUB_ENV
          else
            echo "agent_changed=false" >> $GITHUB_ENV
          fi

      - name: Login to Docker Hub
        if: env.agent_changed == 'true'
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login -u "${{ env.REGISTRY_USERNAME }}" --password-stdin

      - name: Build Agent PoC Image
        if: env.agent_changed == 'true'
        run: |
          docker build --no-cache \
            -t "${{ env.REGISTRY_USERNAME }}/${{ env.AGENT_POC_IMAGE }}:${{ env.DEV_TAG }}" \
            -f agents/windows-go/poc/Dockerfile.poc .

      - name: Push Agent PoC Image
        if: env.agent_changed == 'true'
        run: |
          docker push "${{ env.REGISTRY_USERNAME }}/${{ env.AGENT_POC_IMAGE }}:${{ env.DEV_TAG }}"

  deploy-services:
    name: Deploy Services with Docker Compose
    runs-on: self-hosted
    needs: [build-and-push-orchestrator, build-and-push-mcp-server, build-and-push-ui, build-and-push-agent-poc]
    if: always()
    env:
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      INITIAL_SETUP_TOKEN: ${{ secrets.INITIAL_SETUP_TOKEN }}
      ORCHESTRATOR_API_TOKEN: ${{ secrets.ORCHESTRATOR_API_TOKEN }}
      ORCH_CERT_PRIV: ${{ secrets.ORCH_CERT_PRIV }}
      ORCH_CERT_PUB: ${{ secrets.ORCH_CERT_PUB }}
      UI_CERT_PRIV: ${{ secrets.UI_CERT_PRIV }}
      UI_CERT_PUB: ${{ secrets.UI_CERT_PUB }}
      NGINX_CERT_PRIV: ${{ secrets.NGINX_CERT_PRIV }}
      NGINX_CERT_PUB: ${{ secrets.NGINX_CERT_PUB }}
      NGINX_SERVER_NAME: ${{ secrets.NGINX_SERVER_NAME }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Pull Latest Images
        run: |
          docker compose pull || true

      - name: Validate Required Secrets
        run: |
          required_vars=(
            JWT_SECRET_KEY
            ORCHESTRATOR_API_TOKEN
            ORCH_CERT_PRIV
            UI_CERT_PRIV
            NGINX_CERT_PRIV
          )

          for v in "${required_vars[@]}"; do
            if [ -z "${!v}" ]; then
              echo "Missing required secret/env: $v"
              exit 1
            fi
          done

      - name: Start Services
        run: |
          docker compose up -d --build --remove-orphans

      - name: Wait for Services to be Healthy
        run: |
          echo "Waiting for services to start..."
          NGINX_CID=$(docker compose ps -q nginx)
          if [ -z "$NGINX_CID" ]; then
            echo "✗ Nginx container not found"
            docker compose ps
            exit 1
          fi

          for i in {1..24}; do
            NGINX_HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "$NGINX_CID")
            if [ "$NGINX_HEALTH" = "healthy" ]; then
              echo "✓ Nginx container is healthy"
              break
            fi

            if [ "$i" -eq 24 ]; then
              echo "✗ Nginx did not become healthy"
              docker compose logs nginx
              exit 1
            fi

            echo "Retry $i/24... nginx health=$NGINX_HEALTH"
            sleep 5
          done

          # HTTPS probe via reverse proxy.
          curl -kf https://localhost/api/health >/dev/null

          docker compose ps

      - name: Health Check - Orchestrator (via Nginx HTTPS)
        run: |
          curl -kf https://localhost/api/health || exit 1

      - name: Health Check - MCP Server (container-local)
        run: |
          docker compose exec -T mcp-server curl -f http://localhost:8001/health || exit 1

      - name: Health Check - UI (via Nginx HTTPS)
        run: |
          curl -kf https://localhost || exit 1

      - name: Show Service Logs
        if: failure()
        run: |
          docker compose logs --tail=50
