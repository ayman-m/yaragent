# Observability Stack (Telemetry Plane)

This folder contains the initial telemetry plane scaffold:
- Grafana Alloy: log ingestion and forwarding
- Loki: log storage and query backend
- Grafana: dashboards and alerting UI

All runtime config is generated by the one-shot `init` (bootstrap) container into a shared volume.

Run with:

```bash
docker compose up -d --build
```

## Endpoints
- Loki API: `http://127.0.0.1:3100`
- Alloy ingest (Loki push API compatible): `http://127.0.0.1:9999/loki/api/v1/push`
- Grafana direct UI: `http://127.0.0.1:3001` (admin/admin by default)
- Grafana via app ingress (recommended for embed): `https://localhost/grafana`

## Notes
- This is a phase-1 scaffold to validate end-to-end telemetry flow.
- Grafana dashboards and alerting rules are provisioned from bootstrap-generated config.
- Alloy ingests agent telemetry via API and orchestrator container logs via docker socket.
- Loki retention is bootstrap-controlled via `INIT_OBSERVABILITY_LOKI_RETENTION_PERIOD` (default `168h`).
- Keep telemetry labels bounded: `service`, `tenant_id`, `agent_id`, `event_type`, `severity`, `env`.

## Enterprise SSO (oauth2-proxy + Grafana auth proxy)
Grafana embed is protected via nginx `auth_request` against `oauth2-proxy`.

Default local Keycloak bootstrap (now included):
- Keycloak admin UI: `http://127.0.0.1:8081` (`admin` / `admin`)
- Realm: `yaragent`
- Demo user: `yaradmin` / `yaradmin123!`
- OIDC client: `yaragent-oauth2-proxy`

Required env/secrets:
- `OAUTH2_PROXY_OIDC_ISSUER_URL`
- `OAUTH2_PROXY_CLIENT_ID`
- `OAUTH2_PROXY_CLIENT_SECRET`
- `OAUTH2_PROXY_COOKIE_SECRET`
- `OAUTH2_PROXY_REDIRECT_URL` (must match IdP callback, typically `https://<host>/oauth2/callback`)

Example issuer values:
- Okta: `https://<tenant>.okta.com/oauth2/default`
- Entra ID: `https://login.microsoftonline.com/<tenant-id>/v2.0`
- Auth0: `https://<tenant>.auth0.com/`
- Keycloak: `https://<host>/realms/<realm>`
