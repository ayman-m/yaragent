# Docker Compose orchestration for YARA Agent services
# TLS is enforced end-to-end: nginx -> ui/orchestrator over HTTPS
services:
  orchestrator:
    build:
      context: .
      dockerfile: services/business/orchestrator/Dockerfile
    container_name: yaragent-orchestrator
    expose:
      - "8002"
    environment:
      - LOG_LEVEL=info
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - INITIAL_SETUP_TOKEN=${INITIAL_SETUP_TOKEN:-}
      - ORCHESTRATOR_API_TOKEN=${ORCHESTRATOR_API_TOKEN:-}
      - ORCH_CERT_PRIV=${ORCH_CERT_PRIV}
      - ORCH_CERT_PUB=${ORCH_CERT_PUB}
      - AUTH_DATA_FILE=/app/data/auth.json
    volumes:
      - orchestrator-data:/app/data
    networks:
      - yaragent-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:8002/health"]
      interval: 10s
      timeout: 10s
      retries: 8
      start_period: 20s

  mcp-server:
    build:
      context: .
      dockerfile: services/platform/mcp-server/Dockerfile
    container_name: yaragent-mcp-server
    expose:
      - "8001"
    environment:
      - ORCHESTRATOR_URL=https://orchestrator:8002
      - ORCHESTRATOR_API_TOKEN=${ORCHESTRATOR_API_TOKEN:-}
      - ORCHESTRATOR_TLS_VERIFY=false
      - LOG_LEVEL=info
    depends_on:
      orchestrator:
        condition: service_healthy
    networks:
      - yaragent-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 10s
      retries: 8
      start_period: 20s

  ui:
    build:
      context: .
      dockerfile: services/business/ui/Dockerfile
    container_name: yaragent-ui
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_API_BASE=/api
      - UI_CERT_PRIV=${UI_CERT_PRIV}
      - UI_CERT_PUB=${UI_CERT_PUB}
    depends_on:
      orchestrator:
        condition: service_healthy
    networks:
      - yaragent-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:3000"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s

  nginx:
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile
    container_name: yaragent-nginx
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SERVER_NAME=${NGINX_SERVER_NAME:-localhost}
      - API_TIMEOUT_SECONDS=${API_TIMEOUT_SECONDS:-60}
      - UI_UPSTREAM=ui:3000
      - API_UPSTREAM=orchestrator:8002
      - MCP_UPSTREAM=mcp-server:8001
      - NGINX_CERT_PRIV=${NGINX_CERT_PRIV}
      - NGINX_CERT_PUB=${NGINX_CERT_PUB}
    depends_on:
      orchestrator:
        condition: service_healthy
      ui:
        condition: service_healthy
      mcp-server:
        condition: service_healthy
    networks:
      - yaragent-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost"]
      interval: 10s
      timeout: 10s
      retries: 8
      start_period: 20s

  agent-poc:
    build:
      context: .
      dockerfile: agents/windows-go/poc/Dockerfile.poc
    container_name: yaragent-agent-poc
    command: ["--url", "wss://orchestrator:8002/agent/ws"]
    environment:
      - ENROLL_TOKEN=poc-test-token
    depends_on:
      orchestrator:
        condition: service_healthy
    networks:
      - yaragent-net
    restart: unless-stopped

networks:
  yaragent-net:
    driver: bridge

volumes:
  orchestrator-data:
